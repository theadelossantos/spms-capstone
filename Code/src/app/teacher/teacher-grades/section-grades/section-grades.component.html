<div class="links d-flex">
  <a [routerLink]="['/teacher/grades']">Classes </a>
  <p class="next">></p>
  <a class="active">{{gradeLevelName}} - {{ sectionName }}</a>

</div>

<ng-container *ngIf="selectedSubject; else noSubjectSelected">
<div class="subject-info">
  <p>Subject: {{ selectedSubject.subjectName }}</p>
</div>
</ng-container>


<ng-template #noSubjectSelected>
<p>No Subject Selected</p>
</ng-template>

<form (submit)="submitForm()">
  <select class="form-select shadow-none select-opt" [(ngModel)]="selectedQuarter" name="quarter" (ngModelChange)="onQuarterChange()">
    <option *ngFor="let quarter of quarters" [value]="quarter.quarter_id">{{quarter.quarter_name}}</option>
  </select>
<table>
    <thead>
      <tr>
        <th>No.</th>
        <th>LEARNER'S NAMES</th>
        <th colspan="13">WRITTEN WORKS ({{ calculationWWPercentage  }}%)</th>
        <th colspan="13">PERFORMANCE TASKS ({{ calculationPTPercentage }}%)</th>
        <th colspan="3">QUARTERLY ASSESSMENT({{ calculationQAPercentage }}%)</th>
        <th rowspan="3">Initial Grade</th>
        <th rowspan="3">Quarterly Grade</th>
        <!-- <th rowspan="3">REMARKS</th> -->
      </tr>
      <tr>
        <td></td>
            <td></td>
            <td><b>1</b></td>
            <td><b>2</b></td>
            <td><b>3</b></td>
            <td><b>4</b></td>
            <td><b>5</b></td>
            <td><b>6</b></td>
            <td><b>7</b></td>
            <td><b>8</b></td>
            <td><b>9</b></td>
            <td><b>10</b></td>
            <td><b>Total</b></td>
            <td><b>PS</b></td>
            <td><b>WS</b></td>

            <td><b>1</b></td>
            <td><b>2</b></td>
            <td><b>3</b></td>
            <td><b>4</b></td>
            <td><b>5</b></td>
            <td><b>6</b></td>
            <td><b>7</b></td>
            <td><b>8</b></td>
            <td><b>9</b></td>
            <td><b>10</b></td>
            <td><b>Total</b></td>
            <td><b>PS</b></td>
            <td><b>WS</b></td>

            <td><b>1</b></td>
            <td><b>PS</b></td>
            <td><b>WS</b></td>
      </tr>
      <tr>
            <td></td>
            <td class="hps"><b>HIGHEST POSSIBLE SCORE</b></td>
            <td *ngFor="let hps of formData.writtenWorkHPS; let i = index; trackBy: trackByIndex">
              <input
                type="text"
                [(ngModel)]="formData.writtenWorkHPS[i]"
                (input)="updateTotalWrittenWorkHPS(i)"
                (input)="calculateWeightedScores()"
                [name]="'wwhps' + (i + 1)"
              />
            </td>
            <td class="WWtotalHPS"><b>{{ formData.totalWrittenWorkHPS || ''}}</b></td>
            <td><b>100</b></td>
            <td>
              <input
                type="text"
                [value]="selectedSubject.wwPercentage + '%'"
                (input)="calculateWeightedScores()"
                style="font-weight: bold;"
                name="wwhpsWSpercentage"
                readonly
              />
            </td>
            <td *ngFor="let hps of formData.performanceTaskHPS; let i = index; trackBy: trackByIndex">
              <input
                type="text"
                [(ngModel)]="formData.performanceTaskHPS[i]"
                (input)="updateTotalPerformanceTaskHPS(i)"
                [name]="'pthps' + (i + 1)"
              />
            </td>
            <td><b>{{formData.totalPerformanceTaskHPS || ''}}</b></td>
            <td><b>100</b></td>
            <td>
              <input
                type="text"
                name="pthpsWSpercentage"
                [value]="selectedSubject.ptPercentage + '%'"
                (input)="calculatePTWeightedScores()"
                style="font-weight: bold;"
                readonly
              />
            </td>

            <td><input type="text"  [(ngModel)]="formData.quarterlyAssessmentHPS" (input)="calculateQAWeightedScores()" name="qahps1"/></td>
            <td><b>100</b></td>
            <td>
              <input
                type="text"
                name="qahpsWSpercentage"
                [value]="selectedSubject.qaPercentage + '%'"
                (input)="calculateQAWeightedScores()"
                style="font-weight: bold;"
                readonly
              />
            </td>
      </tr>
      
    </thead>
    <tbody>
      <tr *ngFor="let student of students; let i = index">
        <td>{{ i + 1}}</td>
        <td class="student-name" >{{student.lname}}, {{student.fname}}</td>
        <td *ngFor="let wwScore of student.ww_scores; let j = index; trackBy: trackByIndex">
          <input
            type="text"
            [(ngModel)]="student.ww_scores[j]"
            (input)="updateWrittenWorkRS(student.id, j)"
            (input)="calculateWeightedScores()"
            name="wwrs{{ i }}_{{ j }}" 
          />
        </td>       
        <td>{{student.totalWrittenWorkRS || ''}}</td>
        <td>
          <input
            *ngIf="calculateWWPercentageScore(student.id) !== 0"
            type="text"
            [value]="calculateWWPercentageScore(student.id)"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="wwPS"
          />
          <span *ngIf="calculateWWPercentageScore(student.id) === 0"></span>
        </td>        
        <td>
          <input
            type="text"
            [value]="student.totalWrittenWorkWS || ''"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="wwWS"
          />
        </td>

        <!-- PERFORMANCE TASK -->
        <td *ngFor="let ptScore of student.pt_scores; let j = index; trackBy: trackByIndex">
          <input
            type="text"
            [(ngModel)]="student.pt_scores[j]"
            (input)="updatePerfTaskRS(student.id, j)"
            (input)="calculatePTWeightedScores()"
            name="ptrs{{ i }}_{{ j }}" 
          />
        </td>
        

        <td><input type="text" [value]="student.totalPerfTaskRS || ''" readonly (click)="showStudentId(student.id)" /></td>
        <td>
          <input
            *ngIf="calculatePTPercentageScore(student.id) !== 0"
            type="text"
            [value]="calculatePTPercentageScore(student.id)"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="ptPTS"
          />
          <span *ngIf="calculatePTPercentageScore(student.id) === 0"></span>
        </td>        
        <td>
          <input
            type="text"
            [value]="student.totalPerfTaskWS || ''"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="ptWS"
          />
        </td>
        
        <!-- QUARTERLY ASSESSMENT -->
        <td><input type="text" [(ngModel)]="student.qa_score" (input)="updateQARawScore(student.id)" (input)="calculateQAWeightedScores()" name="qa_score_{{student.id}}"/></td>
        <td>
          <input
            *ngIf="calculateQAPercentageScore(student.id) !== 0"
            type="text"
            [value]="calculateQAPercentageScore(student.id) || ''"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="qaPS"
          />
          <span *ngIf="calculateWWPercentageScore(student.id) === 0"></span>
        </td> 
        <td>
          <input
            type="text"
            *ngIf="student.totalQuarterlyAssessmentWS !== undefined"
            [value]="student.totalQuarterlyAssessmentWS !== undefined ? student.totalQuarterlyAssessmentWS : ''"
            readonly
            (click)="showStudentId(student.id)"
            style="font-weight: bold;"
            name="qaWS"
          />
        </td>

        <td><input class="inigrade" type="text" *ngIf="calculateInitialGrade(student) !== 0" [value]="calculateInitialGrade(student)|| ''" readonly (click)="showStudentId(student.id)" /></td>
        <td [ngStyle]="{ 'background-color': getRank(student.quarterlyGrade) }">
          <input class="quarterly grade" type="text" *ngIf="student.totalQuarterlyAssessmentWS !== undefined && student.totalQuarterlyAssessmentWS !== null && student.totalWrittenWorkWS !== undefined && student.totalPerfTaskWS !== undefined" [value]="student.quarterlyGrade !== undefined ? student.quarterlyGrade : ''" readonly name="quarterlyGrade"/>
        </td>

      </tr>
    </tbody>
  </table>
  <button type="submit" class="btn btn-primary mt-2">Save</button>
</form>

<div class="position-fixed top-0 end-0 p-3">
  <div class="alert alert-danger alert-dismissible fade show" role="alert" *ngIf="showRawScoreAlert">
    Raw Score should be equal or less than HPS!
  </div>
</div>

<div class="position-fixed top-0 end-0 p-3">
  <div class="alert alert-success alert-dismissible fade show" role="alert" *ngIf="saveAlert">
    <strong> Successfully Saved! </strong>
    <button type="button" class="btn-close" (click)="hideAlert()" aria-label="Close"></button>
  </div>
</div>